# DEVELOPING

##  潜在问题

* [安全] 共识节点通过钱包地址和VDF信息运算来进行判断，存在共识节点伪造问题，需要实现VRF后进行认证
* [稳定性] 存在稳定性问题，需要对可能出现的错误进行预判，添加except语句来进行处理
* [稳定性] 在选出共识节点后会一直等待打包，但是如果打包节点一直不打包生成区块会导致整个网络卡住
* [稳定性] 构建测试框架用来完成模块的测试
* [一致性] 存在分叉的问题，需要各个节点根据接收到的区块结合标准来更新最长链（时间+投票数量）
* [一致性] 需要保证在一定时间内完成共识，需要保证在共识结束之后的一致性，能够根据最长链来同步
* [稳定性] 在选出共识节点后会一直等待打包，但是如果打包节点一直不打包生成区块会导致整个网络卡住
* [优化] 区块结构优化，存储交易的merkle树然后根据merkle树来获取交易，交易数据存储在数据库中
* [功能] 加入时间同步功能，让整个区块链的流程更为可控
* [功能] 修改账户模型，不再使用UTxO模型，便于后续和智能合约兼容
* [稳定性] 某次测试中发现TCP连接会挂掉，需要考虑在两个节点之间的TCP连接挂掉的情况下如何恢复通信
* [优化] 交易池的打包速度依然不够理想，最坏的情况下打包速度为 5 tps，需要查找原因并且进行优化

## Todo

* <del>数据库会报错 `Document update conflict`</del>
  > 需要添加线程锁， 在多线程的情况下会出现多个线程同时去操作数据库的情况
  > 
  > 数据库加锁可能影响性能， 暂且显示报错信息不影响节点程序正常运行即可
* 在创建区块时交易校验失败，但是可以创建区块，存在逻辑问题
  > 校验失败出现报错会直接返回上一个函数， 导致能够正常出块
  > 
  > 但是第一次校验成功而校验区块时校验出现问题
  > 
  > upd 2022/3/4:
  > 
  > 该问题没有复现处理， 后续如果出现问题再进行测试
* server-client的连接存在问题, 在接收到交易时出现报错,待修复
* 对于没有同步完成的节点不参与共识（Server/Client端均要进行修改）
* 交易广播方式改为使用UDP线程来进行处理
### 版本todo

## 2022/3/4

* main命令行测试函数中新增init函数
  > `python3 main.py init --node_id=2 --main_node=0`
* 修复了多线程的情况下client发送数据失败的问题
* 新增vote_center给多线程下的client进行信息发送

## 2022/3/6
* 修复未投票结束就产生区块的问题
* 新增了client和server的线程锁用于处理投票的问题（可能存在性能的影响， 需要进行优化）

## 2022/3/9
* client和server的投票信息专门由votecenter来进行处理
* 优化投票信息存储逻辑,新增线程用于处理投票信息(空间换时间)
* 减少client和server发请求的sleep时间, 提高一轮共识的速度

## 版本变更

### v1.1.4

* [优化] 增加区块、交易的缓存结构，并且保证数据库和缓存数据的一致性，提升交易验证、打包速度
* [稳定性] VoteCenter 逻辑修改，在刷新时同时清空队列，修复了存在错误导致线程崩溃的情况
* [稳定性] 优化了MergeThread线程的处理
* [优化] 在交易池中打包交易时不再检索交易是否正确，因为交易在提交到交易池之前已经被验证
* [优化] 使用LRU缓存来存储交易、区块数据
* [稳定性] 优化了VoteCenter的投票逻辑，保证了各节点在投票流程中的信息一致
* [优化] 对数据库中的交易、UTxO的大量增删，调用批量接口来实现，避免多次的I/O导致耗时过长

### v1.1.3

* [优化] 修改交易广播方式，使用gossip协议来进行消息的广播
* [优化] 数据库添加对交易的存储，便于查询时直接查询，而不用以O(n^2)的方式来遍历区块数据

### v1.1.2

* [优化] 增加验证交易时的缓存： 在原有的逻辑下获取前置交易会通过拉取所有区块的方法进行查找， 但是在某些情况下是不必要的， 增加一个cache加速查询
* [功能] 废除在client下发送交易的逻辑， 改为使用gossip协议通过UDP来进行交易的广播
* [优化] 增加交易拉取缓存，暂时不考虑缓存的大小限制
* [稳定性] 添加单节点下的处理过程，保证在只有一个节点的时候也能正常出块
* [稳定性] 删除邻居区块添加逻辑，由MergeThread统一进行区块添加、分叉逻辑的处理
* [功能] Transaction的序列化底层实现逻辑修改，使用深拷贝拷贝投票信息，避免打包时数据清空而出现区块中的投票信息为空的情况
* [优化] 区块打包逻辑修改，在打包时锁住其他线程（Client/Server/Gossip），尽量留出CPU资源给打包线程
* [功能] VoteCenter更新逻辑修改，添加Rollback逻辑，在区块回退的时候同时回退VoteCenter记录的高度和Timer，保证下一轮共识的正常进行
* [项目结构] 目录结构优化，辅助线程移入到thread包，不和网络结构进行耦合

### v1.1.1

* 修改了timer的逻辑， 保证在至少存在创世区块的时候才进行初始化以及时间的记录
* 添加VDF的计算线程， 在计算完成后等待更新

### v1.1.0

* 修改交易池逻辑，通过高度来保证交易打包的正确，避免多个线程重复打包导致出现不同的区块
* 新增Timer来触发一轮共识，在一定间隔时间后进行一次共识，不再通过交易池满这个逻辑来进行判断
* 修改该逻辑后新区块的产生存在一定的问题，待修复
* merkle树逻辑存在问题：在超过数据量的情况下，右节点应该新增一个空节点，而非使用空字符串

### v1.0.4

* openapi解耦，新增grpc用于rpc连接
* openapi通过flask去连接rpc获取数据，不再耦合到节点中
* rpc还可以便于后续cli和浏览器explorer的开发

### v1.0.3

* VoteCenter的改造，新增线程用于处理投票，避免多个线程等待锁导致的等待问题
* 添加docker配置文件，但是在docker下的网络存在问题，待修复

### v1.0.2

* 添加VoteCenter用于处理多线程下投票出现的问题
* 修复server保证和每一个client都有一次通信，避免和单个client信息一致导致的错误

### v1.0.1

添加了openapi，便于进行交易的发送和调试使用，openapi通过flask直接开一个新的服务进行处理

### v1.0.0

项目重构完成版本，将区块链相关的数据结构放入到core中，网络节点相关结构放入到node中，工具类单独列入utils
